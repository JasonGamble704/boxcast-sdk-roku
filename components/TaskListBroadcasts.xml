<?xml version = "1.0" encoding = "utf-8" ?>
<component name="TaskListBroadcasts" extends="Task">

  <interface>
    <field id="params" type="assocarray" />
    <field id="response" type="assocarray" />
  </interface>

  <script type="text/brightscript" uri="pkg:/source/BoxCastAPI.brs"/>
  <script type="text/brightscript" uri="pkg:/source/BoxCastConfig.brs"/>
  <script type="text/brightscript" uri="pkg:/source/utils/GeneralUtils.brs"/>
  <script type="text/brightscript" uri="pkg:/source/utils/HttpUtils.brs"/>
  <script type="text/brightscript" uri="pkg:/source/utils/SGHelperFunctions.brs"/>
  <script type="text/brightscript" uri="pkg:/source/utils/UrlUtils.brs"/>
  <script type="text/brightscript" uri="pkg:/source/Storage.brs"/>

  <script type="text/brightscript">
  <![CDATA[
    sub init()
      m.port = createObject("roMessagePort")
      m.top.functionName = "mainLoop"
      m.top.control = "RUN"
      m.top.observeField("params", m.port)
    end sub

    sub mainLoop()
      while true
        msg = wait(0, m.port)
        mt = type(msg)
        if msg.getField() = "params"
          getBroadcasts(msg.getData())
        end if
      end while
    end sub
    
    sub getBroadcasts(params)
      if params.channel = "__live__" then
        channel = m.global.config.channelId
        live = BoxCastAPI().GetBroadcastsForChannel(channel, "q=timeframe%3Apreroll%20timeframe%3Acurrent%20timeframe%3Anext&s=starts_at&l=1")
        recent = CreateObject("roSGNode", "ContentNode")
      else
        channel = params.channel
        live = BoxCastAPI().GetBroadcastsForChannel(channel, "q=timeframe%3Acurrent&s=-starts_at&l=50")
        recent = BoxCastAPI().GetBroadcastsForChannel(channel, "q=timeframe%3Apast&s=-starts_at&l=50")
      end if
      m.top.response = {live: live, recent: recent}
    end sub
  ]]>
  </script>

</component>
